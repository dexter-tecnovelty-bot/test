name: Preview Validation

on:
  deployment_status:

jobs:
  validate-preview:
    if: ${{ github.event.deployment_status.state == 'success' && contains(fromJSON('["preview","Preview"]'), github.event.deployment.environment) }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Resolve preview URL
        id: preview
        run: |
          set -euo pipefail
          URL="${{ github.event.deployment_status.environment_url }}"
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            URL="${{ github.event.deployment_status.target_url }}"
          fi
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Preview URL was not found in deployment payload."
            exit 1
          fi
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "Preview URL: $URL"

      - name: Validate root path
        run: |
          curl --fail --show-error --silent \
            --location \
            --retry 5 \
            --retry-delay 3 \
            "${{ steps.preview.outputs.url }}" > /dev/null

      - name: Validate auth callback path
        run: |
          curl --fail --show-error --silent \
            --location \
            --retry 5 \
            --retry-delay 3 \
            "${{ steps.preview.outputs.url }}/auth/callback" > /dev/null
